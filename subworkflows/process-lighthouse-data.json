{
  "name": "PageSpeed API Call",
  "nodes": [
    {
      "parameters": {
        "url": "https://www.googleapis.com/pagespeedonline/v5/runPagespeed",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpQueryAuth",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "url",
              "value": "={{ $json.urls }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -960,
        192
      ],
      "id": "caea6d0b-b882-4c97-8b6f-d63646c98bde",
      "name": "PageSpeed API Call",
      "credentials": {
        "httpQueryAuth": {
          "id": "vJErJnF3RSSJZ11N",
          "name": "Query Auth account"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "8026435c-a3e2-4132-a378-a6b12a71c18d",
              "name": "lighthouseResult.categories.performance.score",
              "value": "={{ $('PageSpeed API Call').item.json.lighthouseResult.categories.performance.score }}",
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -512,
        288
      ],
      "id": "711555bf-93cd-4e42-a06d-8e535621bd8d",
      "name": "Pull out the Lighthouse score"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "b8c19c03-c777-478d-a66d-4b8cd4a8e6e9",
              "leftValue": "={{ $json.loadingExperience && $json.loadingExperience.overall_category }}",
              "rightValue": "=true",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": "={{ true }}",
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -736,
        96
      ],
      "id": "cd77a44c-6d2c-4106-8243-39b798cb220f",
      "name": "Is field data available (i.e. data from real users)"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "a40762d8-30a8-444e-8182-94e792db540e",
              "leftValue": "={{ $json.loadingExperience.overall_category }}",
              "rightValue": "\"FAST\"",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -512,
        0
      ],
      "id": "ebbdce62-5b4b-4f1c-88bc-2c67cd0fe30d",
      "name": "Does the website already run fast?"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "361fca0b-1728-42ea-907a-6fd25d830310",
              "leftValue": "={{ $json.lighthouseResult.categories.performance.score }}",
              "rightValue": 60,
              "operator": {
                "type": "number",
                "operation": "gte"
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -288,
        288
      ],
      "id": "1952c597-27dd-4ae7-8753-9641148b5417",
      "name": "Is the lighthouse score above 60?"
    },
    {
      "parameters": {
        "workflowInputs": {
          "values": [
            {
              "name": "urls"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        -1184,
        192
      ],
      "id": "61b9b28f-b36a-497c-8142-37b19c973ea4",
      "name": "When Executed by Another Workflow"
    },
    {
      "parameters": {
        "content": "n8n has an annoying quirk where it always returns something to the main flow, so I'm setting the objects being returned by the false paths as something easily filtered out in the main flow\n"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -80,
        -16
      ],
      "typeVersion": 1,
      "id": "f3bcbc6a-4092-4255-82fe-a1dea218f91c",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "jsCode": "// // Get the URL from the loop iteration\n// const url = $('When Executed by Another Workflow').item.json.url;\n\n// // Extract Lighthouse data from current node input\n// const lr = $json.lighthouseResult;\n\n// // Extract LCP data\n// const lcpAudit = lr.audits['largest-contentful-paint'];\n// const lcp_percentile = Math.round(lcpAudit.numericValue);\n// const lcp_score = lcpAudit.score >= 0.9 ? 'FAST' : (lcpAudit.score >= 0.5 ? 'AVERAGE' : 'SLOW');\n\n// // Extract CLS data\n// const clsAudit = lr.audits['cumulative-layout-shift'];\n// const cls_percentile = clsAudit.numericValue;\n// const cls_category = cls_percentile < 0.1 ? 'FAST' : (cls_percentile < 0.25 ? 'AVERAGE' : 'SLOW');\n\n// // Extract TBT (INP equivalent for lab data)\n// const tbtAudit = lr.audits['total-blocking-time'];\n// const inp_percentile = Math.round(tbtAudit.numericValue);\n// const inp_category = inp_percentile < 200 ? 'FAST' : (inp_percentile < 600 ? 'AVERAGE' : 'SLOW');\n\n// // Extract Lighthouse performance score\n// const lighthouse_score = lr.categories.performance.score * 100;\n\n// // Determine overall category from lighthouse score\n// const overall_category = lighthouse_score >= 90 ? 'FAST' : (lighthouse_score >= 50 ? 'AVERAGE' : 'SLOW');\n\n// return {\n//   url: url,\n//   source: \"lighthouse_report\",\n//   lcp_percentile: lcp_percentile,\n//   lcp_score: lcp_score,\n//   inp_percentile: inp_percentile,\n//   inp_category: inp_category,\n//   cls_percentile: cls_percentile,\n//   cls_category: cls_category,\n//   overall_category: overall_category,\n//   lighthouse_score: lighthouse_score\n// };\n\n// I left all this out because if the site isn't getting enough traffic for user-generated data to be available, it's probably not really worth the time reaching out to. \n\nreturn {\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -64,
        384
      ],
      "id": "f668b549-1519-4afc-9bd9-cb2db995fb05",
      "name": "Return the report"
    },
    {
      "parameters": {
        "jsCode": "return {\n  url: $('When Executed by Another Workflow').item.json.urls,\n  source: \"field_data\",\n  lcp_percentile: $json.loadingExperience?.metrics?.LARGEST_CONTENTFUL_PAINT_MS?.percentile ?? null,\n  lcp_score: $json.loadingExperience?.metrics?.LARGEST_CONTENTFUL_PAINT_MS?.category ?? 'no_data',\n  inp_percentile: $json.loadingExperience?.metrics?.INTERACTION_TO_NEXT_PAINT?.percentile ?? null,\n  inp_category: $json.loadingExperience?.metrics?.INTERACTION_TO_NEXT_PAINT?.category ?? 'no_data',\n  cls_percentile: ($json.loadingExperience?.metrics?.CUMULATIVE_LAYOUT_SHIFT_SCORE?.percentile ?? 0) / 100,\n  cls_category: $json.loadingExperience?.metrics?.CUMULATIVE_LAYOUT_SHIFT_SCORE?.category ?? 'no_data',\n  overall_category: $json.loadingExperience?.overall_category ?? 'no_data',\n  lighthouse_score: ($json.lighthouseResult?.categories?.performance?.score ?? 0) * 100\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -288,
        96
      ],
      "id": "12776ea7-5925-4863-b911-a60f6af59da6",
      "name": "Return the report1"
    },
    {
      "parameters": {
        "jsCode": "return {\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -64,
        192
      ],
      "id": "3dc5d979-5ff1-45c0-b35b-a94fe974b1f0",
      "name": "Return dummy object"
    },
    {
      "parameters": {
        "jsCode": "return {\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -288,
        -96
      ],
      "id": "2a35fef6-e3a9-4466-99c9-1fed1206cfa8",
      "name": "Return dummy object1"
    },
    {
      "parameters": {
        "jsCode": "return {\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -736,
        288
      ],
      "id": "82d858e0-edc0-4fb9-b875-5556a7fa9d5a",
      "name": "Return dummy object2"
    },
    {
      "parameters": {
        "content": "Set your Google Cloud API key here as query auth acct",
        "height": 80
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1056,
        384
      ],
      "typeVersion": 1,
      "id": "956c3e59-242e-46ee-904d-1869c83f225d",
      "name": "Sticky Note1"
    }
  ],
  "pinData": {},
  "connections": {
    "PageSpeed API Call": {
      "main": [
        [
          {
            "node": "Is field data available (i.e. data from real users)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Return dummy object2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pull out the Lighthouse score": {
      "main": [
        [
          {
            "node": "Is the lighthouse score above 60?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is field data available (i.e. data from real users)": {
      "main": [
        [
          {
            "node": "Does the website already run fast?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Pull out the Lighthouse score",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Does the website already run fast?": {
      "main": [
        [
          {
            "node": "Return dummy object1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Return the report1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is the lighthouse score above 60?": {
      "main": [
        [
          {
            "node": "Return dummy object",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Return the report",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "When Executed by Another Workflow": {
      "main": [
        [
          {
            "node": "PageSpeed API Call",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "08fa4a2d-e1a7-4eec-80d4-bf46d58af33f",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "caa97ec828044ebe5f6dfa934955be9af1a27616800ca0bafa1f9b4819663c57"
  },
  "id": "6Wl53zPYJoEmCBPY",
  "tags": []
}